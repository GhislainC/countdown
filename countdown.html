<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compte Ã  Rebours Configurable</title>
    <link href="font.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            text-align: center;
            color: white;
            background-color: black;
        }
        #countdown {
            font-size: 25vw;
            margin: 0;
            font-family: 'Azeret Mono', monospace; /* Police Ã  chasse fixe */
        }
        #current-time {
            font-size: 5vw;
            font-family: 'Azeret Mono', monospace; /* Police Ã  chasse fixe */
        }
        #config {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(180, 179, 179, 1);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .config-item {
            margin: 10px 0;
            font-size: 2vw;
        }
        .buttons {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        button {
            font-size: 2vw;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="config">
        <div class="config-item">
            <label for="duration">DurÃ©e (en minutes) :</label>
            <input type="number" id="duration" min="1" value="45">
        </div>
        <div class="config-item">
            <label for="threshold">Seuil d'avertissement (en secondes) :</label>
            <input type="number" id="threshold" min="1" value="120">
        </div>
        <button id="startButton">Charger</button>
    </div>

    <div id="main_controls" class="buttons">   
        <button id="sub10min">-10 min</button> 
        <button id="sub5min">-5 min</button>
        <button id="sub1min">-1 min</button>
        <button id="pauseButton">Pause</button>
        <button id="add1min">+1 min</button>
        <button id="add5min">+5 min</button>
        <button id="add10min">+10 min</button>
        <button id="timeOnly">Heure</button>
        <button id="toggleConfig">Config</button>
    </div>

    <div id="countdown">--:--</div>
    <div id="current-time">-- -------- -- --:--</div>

    <script>
        // Variables globales
        let config = {
            countdownDuration: 0,
            warningThreshold: 0
        }
        
        let context = {
            remainingTime: 0,
            warningThreshold: 0,
            isPaused: false,
            isStarted: false,
            timeOnly: false
        }

        let countdownInterval;        

        // DOM Elements
        const countdownElement = document.getElementById('countdown');
        const currentTimeElement = document.getElementById('current-time');
        const configElement = document.getElementById('config');
        const mainControlsElements = document.getElementById('main_controls');
        const durationInput = document.getElementById('duration');
        const thresholdInput = document.getElementById('threshold');
        const startButton = document.getElementById('startButton');
        const pauseButton = document.getElementById('pauseButton');
        const add1minButton = document.getElementById('add1min');
        const add5minButton = document.getElementById('add5min');
        const add10minButton = document.getElementById('add10min');
        const sub1minButton = document.getElementById('sub1min');
        const sub5minButton = document.getElementById('sub5min');
        const sub10minButton = document.getElementById('sub10min');
        const timeOnlyButton = document.getElementById('timeOnly');
        const toggleConfigButton = document.getElementById('toggleConfig');

        // Session Identifier
        var session_id = null;
        var i_am_master = false;
        var masterExists = false;
        const own_id = crypto.randomUUID();
        const fragments = new URLSearchParams(
            window.location.hash.substring(1) // any_hash_key=any_value
        );
        session_id = fragments.get('session') || ""
        if (session_id != "") {

        } else {
            session_id = crypto.randomUUID();
        }
        const bc = new BroadcastChannel(`countdown.${session_id}`);        
        console.log(`session_id=${session_id}`);

        let wakeLock = null;  // Variable pour stocker l'Ã©tat du Wake Lock
        async function setScreenAwake(shouldKeepAwake) {
            if (shouldKeepAwake) {
                // Si l'on souhaite garder l'Ã©cran Ã©veillÃ©
                if (!wakeLock) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Ã‰cran verrouillÃ© pour rester allumÃ©.');
                } catch (err) {
                    console.error('Erreur lors de l\'activation du Wake Lock:', err);
                }
                }
            } else {
                // Si l'on souhaite permettre Ã  l'Ã©cran de se verrouiller
                if (wakeLock) {
                await wakeLock.release();
                wakeLock = null;
                console.log('Ã‰cran peut maintenant se verrouiller.');
                }
            }
        }
        window.addEventListener('beforeunload', () => {
            setScreenAwake(false);
            sendCmd('master-dead', {id: own_id})
            bc.close();
          });

        bc.onmessage = (event) => {
            data = event.data;
            console.log(`Broadcast from ${data.sender}: ${JSON.stringify(data)}`)
            if (i_am_master) {

            } else {
                if (data.context) {
                    context = data.context;
                    updateCountdown();
                    updatePause();
                }
            }
            if (data.config) {
                config = data.config;                
            }
            if (data.cmd) {                
                switch(data.cmd.name) {
                    case 'start': 
                        configElement.classList.add('hidden');
                        initStart();
                        startCountdown();                        
                    break;
                    case 'hello':                     
                        if (i_am_master) {
                            sendCmd('master-exists', {id: own_id});
                        }
                    break;
                    case 'master-exists': 
                        if (!i_am_master) {
                            console.log("Another master exists:", data.cmd.data.id);
                            masterExists = true;
                        }
                        document.title = `CD m=${i_am_master} s=${session_id}`
                    break;
                    /*case 'master-dead':
                        if (!i_am_master) {
                            console.log("Master died, re-electing...");
                            electMaster();
                        }
                    break;*/
                    case 'pause':
                        context.isPaused = data.cmd.data
                        updatePause();
                        sendContext();
                    break;
                    case 'timeOnly':
                        context.timeOnly = data.cmd.data
                        initStart();
                        startCountdown();   
                        updateTimeOnly();
                        context.isPaused = !context.timeOnly;
                        updatePause();
                        sendContext();
                        updateCountdown();
                        updateCurrentTime();
                    break;
                    case 'addTime':
                        if (i_am_master) {
                            addTime(data.cmd.data)
                        }
                    break;
                    case 'subtractTime':
                        if (i_am_master) {
                            subtractTime(data.cmd.data)
                        }
                    break;
                }
            }
        };

        function announcePresence() {
            sendCmd("hello", {id: own_id });
        }

        function electMaster() {
            masterExists = false;
            announcePresence();

            // Attendre un peu pour voir si un master rÃ©pond
            setTimeout(() => {
                if (!masterExists) {
                    i_am_master = true;
                    console.log("ðŸŸ¢ I am the new master:", own_id);
                    sendCmd("new-master", {id: own_id });
                } else {
                    console.log("ðŸ”µ I am a slave:", own_id);
                }
                document.title = `CD m=${i_am_master} s=${session_id}`
            }, 500);
        }
        electMaster();

        function sendContext() {
            if (i_am_master) {
                bc.postMessage({sender: own_id, context: context})
            }
        }

        function sendConfig() {
            bc.postMessage({sender: own_id, config: config})
        }

        function sendCmd(cmd_name, data) {
            bc.postMessage({
                sender: own_id, 
                cmd: {
                    name: cmd_name,
                    data: data
                }
            })
        }

        // Formatage du temps en mm:ss (compte Ã  rebours)
        function formatCountdownTime(seconds) {
            const mins = String(Math.floor(Math.abs(seconds) / 60)).padStart(2, '0');
            const secs = String(Math.abs(seconds) % 60).padStart(2, '0');
            return `${seconds < 0 ? '-' : ''}${mins}:${secs}`;
        }

        function capitalize(s)
        {
            return String(s[0]).toUpperCase() + String(s).slice(1);
        }

        // Formatage de l'heure actuelle en hh:mm
        function formatCurrentTime(date=true, time=true) {
            const now = new Date();
            const year = String(now.getFullYear()).padStart(4, '0');
            //const month = String(now.getMonth() + 1).padStart(2, '0');
            const month = capitalize(now.toLocaleString('default', { month: 'long' }));
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            var ret = []
            if (date) {
                ret.push(`${day} ${month} ${year}`)
            }
            if (time) {
                ret.push(`${hours}:${minutes}`)
            }
            return ret.join(' ')
        }

        // Met Ã  jour l'heure actuelle
        function updateCurrentTime() {
            currentTimeElement.textContent = formatCurrentTime(date=true, time=!context.timeOnly);
        }

        // Met Ã  jour le compte Ã  rebours
        function updateCountdown() {
            if (context.timeOnly) {
                countdownElement.textContent = formatCurrentTime(date=false);
            } else {
                if (!context.isPaused) {
                    if (i_am_master) {
                        context.isStarted = true;
                        context.remainingTime--;
                        sendContext();                    
                    }                
                } else {
                    if ((new Date()).getSeconds()%2 == 0) {
                        pauseButton.style.backgroundColor = 'red';
                    } else {
                        pauseButton.style.backgroundColor = '';
                    }
                }
                countdownElement.textContent = formatCountdownTime(context.remainingTime);
            }            
            updatePauseLabel();
            // Change le background en fonction du temps restant
            if (!context.timeOnly && context.remainingTime <= context.warningThreshold && context.remainingTime > 0) {
                document.body.style.backgroundColor = '#FF8C00'; // Orange moins lumineux
                document.body.style.color = 'black'; // Texte noir pour contraste
            } else if (!context.timeOnly && context.remainingTime <= 0) {
                document.body.style.backgroundColor = 'red';
                document.body.style.color = 'white'; // Texte blanc sur fond rouge
            } else {
                document.body.style.backgroundColor = 'black';
                document.body.style.color = 'white';
            }
        }

        // DÃ©marre le compte Ã  rebours
        function startCountdown() {
            countdownElement.textContent = formatCountdownTime(context.remainingTime);
            document.body.style.backgroundColor = 'black';

            clearInterval(countdownInterval);
            countdownInterval = setInterval(updateCountdown, 1000);

            if (i_am_master) {
                mainControlsElements.classList.add('hidden');
                configElement.classList.add('hidden');
            }
            
            countdownElement.style.backgroundColor = 'red';
            document.body.style.color = 'white';
            setScreenAwake(true);
            updatePause();
            sendContext();
        }

        function configureStart() {
            config.countdownDuration = parseInt(durationInput.value) * 60;
            config.warningThreshold = parseInt(thresholdInput.value);

            configElement.classList.add('hidden');

            sendConfig();
            initStart();
            startCountdown();
            sendCmd('start');
        }

        function initStart() {
            if (i_am_master) {
                context.isStarted = false;
                context.remainingTime = config.countdownDuration;
                context.warningThreshold = config.warningThreshold;
                context.isPaused = true;
            }
        }
        // GÃ©rer le bouton Pause/Reprendre
        function togglePause() {
            context.isPaused = !context.isPaused;
            updatePause();
            sendCmd('pause', context.isPaused);

        }

        function updatePauseLabel() {
            if (context.isStarted) {
                pauseButton.textContent = context.isPaused ? 'Reprendre' : 'Pause';
            } else {
                pauseButton.textContent = 'DÃ©marrer';
            }
        }

        function updatePause() {
            updatePauseLabel();
            if (context.isPaused) {
                pauseButton.style.backgroundColor = 'red';
                countdownElement.style.backgroundColor = 'red';
                setScreenAwake(false);
            } else {
                pauseButton.style.backgroundColor = '';
                countdownElement.style.backgroundColor = '';
                setScreenAwake(true);
            }
        }

        // Ajouter du temps au compte Ã  rebours
        function addTime(seconds) {
            if (i_am_master) {
                context.remainingTime += seconds;
                countdownElement.textContent = formatCountdownTime(context.remainingTime);
                sendContext();
            } else {
                sendCmd('addTime', seconds)
            }
        }

        // Retirer du temps au compte Ã  rebours
        function subtractTime(seconds) {
            if (i_am_master) {
                context.remainingTime -= seconds;
                countdownElement.textContent = formatCountdownTime(context.remainingTime);
                sendContext();
            } else {
                sendCmd('subtractTime', seconds)
            }
        }

        // Afficher/Masquer la configuration
        function toggleConfig() {
            configElement.classList.toggle('hidden');
        }

        // GÃ©rer le bouton Pause/Reprendre
        function toggleTimeOnly() {
            context.timeOnly = !context.timeOnly;
            initStart();
            startCountdown();   
            updateTimeOnly();
            sendCmd('timeOnly', context.timeOnly);
            updateCountdown();
            updateCurrentTime();

        }

        function updateTimeOnlyLabel() {
            timeOnlyButton.textContent = context.timeOnly ? 'Chrono' : 'Heure';
        }

        function updateTimeOnly() {
            updateTimeOnlyLabel();
            if (context.timeOnly) {
                timeOnlyButton.style.backgroundColor = 'red';
                setScreenAwake(true);
            } else {
                timeOnlyButton.style.backgroundColor = '';
                setScreenAwake(!context.isPaused);
            }
        }

        // Mise Ã  jour de l'heure actuelle toutes les secondes
        setInterval(updateCurrentTime, 1000);

        // Attacher les Ã©vÃ©nements
        startButton.addEventListener('click', configureStart);
        pauseButton.addEventListener('click', togglePause);
        add1minButton.addEventListener('click', () => addTime(60));
        add5minButton.addEventListener('click', () => addTime(300));
        add10minButton.addEventListener('click', () => addTime(600));
        sub1minButton.addEventListener('click', () => subtractTime(60));
        sub5minButton.addEventListener('click', () => subtractTime(300));
        sub10minButton.addEventListener('click', () => subtractTime(600));
        toggleConfigButton.addEventListener('click', toggleConfig);
        timeOnlyButton.addEventListener('click', toggleTimeOnly);

    </script>
</body>
</html>
